<div class="min-h-screen bg-gray-50 py-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <%= link_to "ImmoPromo", immo_promo_engine.root_path, 
                    class: "inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600" %>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <% if @document.documentable %>
              <% case @document.documentable %>
              <% when Immo::Promo::Project %>
                <%= link_to "Projet #{@document.documentable.name}", immo_promo_engine.project_path(@document.documentable), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% when Immo::Promo::Phase %>
                <%= link_to "Projet #{@document.documentable.project.name}", immo_promo_engine.project_path(@document.documentable.project), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% when Immo::Promo::Task %>
                <%= link_to "Projet #{@document.documentable.project.name}", immo_promo_engine.project_path(@document.documentable.project), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% when Immo::Promo::Permit %>
                <%= link_to "Projet #{@document.documentable.project.name}", immo_promo_engine.project_path(@document.documentable.project), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% when Immo::Promo::Stakeholder %>
                <%= link_to "Projet #{@document.documentable.project.name}", immo_promo_engine.project_path(@document.documentable.project), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% end %>
            <% else %>
              <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Documents</span>
            <% end %>
          </div>
        </li>
        <% if @document.documentable %>
          <li>
            <div class="flex items-center">
              <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <% case @document.documentable %>
              <% when Immo::Promo::Project %>
                <%= link_to "Documents", immo_promo_engine.project_documents_path(@document.documentable), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% when Immo::Promo::Phase %>
                <%= link_to "Documents", immo_promo_engine.phase_documents_path(@document.documentable), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% when Immo::Promo::Task %>
                <%= link_to "Documents", immo_promo_engine.task_documents_path(@document.documentable), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% when Immo::Promo::Permit %>
                <%= link_to "Documents", immo_promo_engine.permit_documents_path(@document.documentable), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% when Immo::Promo::Stakeholder %>
                <%= link_to "Documents", immo_promo_engine.stakeholder_documents_path(@document.documentable), 
                          class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2" %>
              <% end %>
            </div>
          </li>
        <% end %>
        <li aria-current="page">
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2"><%= truncate(@document.title, length: 30) %></span>
          </div>
        </li>
      </ol>
    </nav>

    <!-- Document Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Document Header -->
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <svg class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <div class="ml-4">
                  <h1 class="text-xl font-bold text-gray-900"><%= @document.title %></h1>
                  <div class="mt-1 flex items-center text-sm text-gray-500">
                    <span>Ajouté par <%= @document.uploaded_by.full_name if @document.uploaded_by %></span>
                    <span class="mx-2">•</span>
                    <span><%= time_ago_in_words(@document.created_at) %> ago</span>
                    <% if @document.file.attached? %>
                      <span class="mx-2">•</span>
                      <span><%= number_to_human_size(@document.file.blob.byte_size) %></span>
                    <% end %>
                  </div>
                </div>
              </div>
              
              <!-- Document Category & Tags -->
              <div class="mt-4 flex items-center space-x-3">
                <% if @document.document_category.present? %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    <%= @document.document_category.humanize %>
                  </span>
                <% end %>
                
                <% @document.tags.each do |tag| %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    #<%= tag.name %>
                  </span>
                <% end %>
              </div>
              
              <!-- Description -->
              <% if @document.description.present? %>
                <div class="mt-4">
                  <p class="text-gray-700"><%= @document.description %></p>
                </div>
              <% end %>
            </div>
            
            <!-- Action Buttons -->
            <div class="ml-6 flex space-x-3">
              <%= link_to immo_promo_engine.download_document_path(@document), 
                        class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Télécharger
              <% end %>
              
              <% if Immo::Promo::DocumentPolicy.new(current_user, @document).update? %>
                <button type="button" 
                        onclick="openEditModal()"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  Modifier
                </button>
              <% end %>

              <!-- More Actions Dropdown -->
              <div class="relative inline-block text-left">
                <button type="button" 
                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        id="more-actions-menu"
                        onclick="toggleDropdown('more-actions')">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                  </svg>
                </button>
                
                <div id="more-actions-dropdown" class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                  <div class="py-1">
                    <% if Immo::Promo::DocumentPolicy.new(current_user, @document).share? %>
                      <a href="#" onclick="openShareModal()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                        </svg>
                        Partager
                      </a>
                    <% end %>
                    
                    <% if Immo::Promo::DocumentPolicy.new(current_user, @document).request_validation? %>
                      <a href="#" onclick="openValidationModal()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Demander validation
                      </a>
                    <% end %>
                    
                    <% if Immo::Promo::DocumentPolicy.new(current_user, @document).lock_document? && !@document.locked? %>
                      <a href="#" onclick="lockDocument()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                        </svg>
                        Verrouiller
                      </a>
                    <% elsif Immo::Promo::DocumentPolicy.new(current_user, @document).unlock_document? && @document.locked? %>
                      <a href="#" onclick="unlockDocument()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path fill-rule="evenodd" d="M15 7a3 3 0 11-6 0V4a1 1 0 00-1-1H7a1 1 0 000 2v1a5 5 0 0010 0V6a1 1 0 000-2h-1a1 1 0 00-1 1v1z" clip-rule="evenodd" />
                        </svg>
                        Déverrouiller
                      </a>
                    <% end %>
                    
                    <% if @document_versions.any? %>
                      <a href="#" onclick="showVersionHistory()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Historique des versions
                      </a>
                    <% end %>
                    
                    <% if Immo::Promo::DocumentPolicy.new(current_user, @document).destroy? %>
                      <div class="border-t border-gray-100"></div>
                      <%= link_to immo_promo_engine.document_path(@document), 
                                method: :delete,
                                class: "block px-4 py-2 text-sm text-red-700 hover:bg-red-100",
                                confirm: "Êtes-vous sûr de vouloir supprimer ce document ?",
                                data: { method: :delete } do %>
                        <svg class="w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Supprimer
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Document Preview -->
        <% if @document.file.attached? %>
          <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Aperçu du document</h3>
            
            <% if @document.image? %>
              <!-- Image Preview -->
              <div class="text-center">
                <%= image_tag @document.file, 
                            class: "max-w-full h-auto rounded-lg shadow-lg mx-auto",
                            style: "max-height: 600px;" %>
              </div>
            <% elsif @document.pdf? %>
              <!-- PDF Preview -->
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-center h-96 border-2 border-dashed border-gray-300 rounded-lg">
                  <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Document PDF</h3>
                    <p class="mt-1 text-sm text-gray-500">
                      Téléchargez le fichier pour le visualiser
                    </p>
                    <%= link_to "Télécharger le PDF", immo_promo_engine.download_document_path(@document), 
                              class: "mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700" %>
                  </div>
                </div>
              </div>
            <% else %>
              <!-- Other file types -->
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-center h-64 border-2 border-dashed border-gray-300 rounded-lg">
                  <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">
                      <%= @document.file.blob.filename %>
                    </h3>
                    <p class="mt-1 text-sm text-gray-500">
                      Type: <%= @document.file.blob.content_type %>
                    </p>
                    <%= link_to "Télécharger", immo_promo_engine.download_document_path(@document), 
                              class: "mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700" %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Document Status -->
        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Statut du document</h3>
          <%= render Immo::Promo::Documents::DocumentStatusComponent.new(
                document: @document,
                show_details: true
              ) %>
        </div>

        <!-- Document Information -->
        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Informations</h3>
          <dl class="space-y-3">
            <div>
              <dt class="text-sm font-medium text-gray-500">Type de fichier</dt>
              <dd class="text-sm text-gray-900"><%= @document.document_type.humanize if @document.file.attached? %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Taille</dt>
              <dd class="text-sm text-gray-900"><%= number_to_human_size(@document.file.blob.byte_size) if @document.file.attached? %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Créé le</dt>
              <dd class="text-sm text-gray-900"><%= l(@document.created_at, format: :long) %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Modifié le</dt>
              <dd class="text-sm text-gray-900"><%= l(@document.updated_at, format: :long) %></dd>
            </div>
            <% if @document.documentable %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Attaché à</dt>
                <dd class="text-sm text-gray-900">
                  <% case @document.documentable %>
                  <% when Immo::Promo::Project %>
                    Projet: <%= @document.documentable.name %>
                  <% when Immo::Promo::Phase %>
                    Phase: <%= @document.documentable.name %>
                  <% when Immo::Promo::Task %>
                    Tâche: <%= @document.documentable.name %>
                  <% when Immo::Promo::Permit %>
                    Permis: <%= @document.documentable.permit_name %>
                  <% when Immo::Promo::Stakeholder %>
                    Intervenant: <%= @document.documentable.name %>
                  <% end %>
                </dd>
              </div>
            <% end %>
          </dl>
        </div>

        <!-- Validation Information -->
        <% if @validation_status && @validation_status[:status] != 'none' %>
          <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Validation</h3>
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-500">Statut</span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  <%= @validation_status[:status].humanize %>
                </span>
              </div>
              <% if @validation_status[:requester] %>
                <div>
                  <dt class="text-sm font-medium text-gray-500">Demandé par</dt>
                  <dd class="text-sm text-gray-900"><%= @validation_status[:requester] %></dd>
                </div>
              <% end %>
              <% if @validation_status[:progress] %>
                <div>
                  <dt class="text-sm font-medium text-gray-500">Progression</dt>
                  <dd class="text-sm text-gray-900"><%= @validation_status[:progress] %>%</dd>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Shares -->
        <% if @shares.any? %>
          <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Partages</h3>
            <div class="space-y-3">
              <% @shares.each do |share| %>
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <div class="flex-shrink-0">
                      <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                    </div>
                    <div class="ml-3">
                      <p class="text-sm font-medium text-gray-900">
                        <%= share.shared_with_user&.full_name || share.shared_with_email %>
                      </p>
                      <p class="text-xs text-gray-500">
                        <%= share.permission_level.humanize %> • <%= time_ago_in_words(share.created_at) %> ago
                      </p>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Document Versions -->
        <% if @document_versions.any? %>
          <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Versions</h3>
            <div class="space-y-3">
              <% @document_versions.first(5).each do |version| %>
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <div class="flex-shrink-0">
                      <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-blue-100 text-blue-800 text-xs font-medium">
                        v<%= version.version_number %>
                      </span>
                    </div>
                    <div class="ml-3">
                      <p class="text-sm font-medium text-gray-900">
                        Version <%= version.version_number %>
                        <% if version.is_current? %>
                          <span class="text-xs text-green-600">(actuelle)</span>
                        <% end %>
                      </p>
                      <p class="text-xs text-gray-500">
                        <%= time_ago_in_words(version.created_at) %> ago
                      </p>
                    </div>
                  </div>
                </div>
              <% end %>
              <% if @document_versions.count > 5 %>
                <button onclick="showVersionHistory()" class="text-sm text-blue-600 hover:text-blue-500">
                  Voir toutes les versions (<%= @document_versions.count %>)
                </button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleDropdown(id) {
    const dropdown = document.getElementById(id + '-dropdown');
    dropdown.classList.toggle('hidden');
  }

  function openEditModal() {
    // Implementation for edit modal
    alert('Fonctionnalité d\'édition à implémenter');
  }

  function openShareModal() {
    // Implementation for share modal
    alert('Fonctionnalité de partage à implémenter');
  }

  function openValidationModal() {
    // Implementation for validation request modal
    alert('Fonctionnalité de demande de validation à implémenter');
  }

  function lockDocument() {
    // Implementation for document locking
    alert('Fonctionnalité de verrouillage à implémenter');
  }

  function unlockDocument() {
    // Implementation for document unlocking
    alert('Fonctionnalité de déverrouillage à implémenter');
  }

  function showVersionHistory() {
    // Implementation for version history modal
    alert('Historique des versions à implémenter');
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#more-actions-menu')) {
      document.getElementById('more-actions-dropdown').classList.add('hidden');
    }
  });
</script>